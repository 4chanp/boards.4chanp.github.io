<!DOCTYPE html>
<html>
	<!--
	i did this for my self, code is garbage, and full of bugs.
	i don`t care...
	bookmarklet: javascript:location.href=location.href.replace('4chan', '4chanp');
	-->
	<head>
		<style type="text/css">
			html {
				position: relative;
				width: 100%;
				height: 100%;
				margin: 0;
			}

			body {
				background: #777;
				color: #ededed;
				position: relative;
				width: 100%;
				height: 100%;
				margin: 0;
			}

			#viewer {
				height: 100%;
				width: 100%;
				 background-size: contain;
				 background-position: 50% 50%;
				 background-repeat: no-repeat;
			}


			#videoViewer {
				height: 100%;
				width: 100%;
				margin: 0 auto;
				z-index: 50;
			}

			#counter {
				position: absolute;
				top: 10px;
				left: 10px;
				font-size: 36px;
				z-index: 800;
			}

			#auto {
				position: absolute;
				bottom: 10px;
				left: 10px;
				z-index: 800;
			}

			#prevButton,
			#nextButton {
				position: absolute;
				top: 50%;
				font-size: 36px;
				cursor: pointer;
				z-index: 800;
			}

			#prevButton {
				left: 10px;
			}

			#nextButton {
				right: 10px;
			}

		</style>
	</head>
	<body>

		<div id="prevButton" title="Use arrow keys!">&lt;</div>
		<div id="nextButton" title="Use arrow keys!">&gt;</div>
		<div id="counter"></div>
		<div id="auto">
			<input id="autoCb" type="checkbox" checked="checked" />
			<label>
				<b>Auto Next</b> every:
				<input id="autoSec" type="text" value="5" /> seconds
			</label>
		</div>
		<div id="viewer">
			<video id="videoViewer" autoplay="autoplay" loop="loop"></video>
		</div>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script type="text/javascript">
			(function(global){
				$(function() {

					var NOOP = function(){};
					var path = document.location.pathname;
					var pathArray = path.split('/');
					pathArray.shift();
					var board = pathArray.shift();
					pathArray.shift();
					var thread = pathArray.shift();
					var threadJsonp = document.createElement('script');
					threadJsonp.src = 'http://json2jsonp.com/?url=http://a.4cdn.org/' + [board, 'thread', thread].join('/') + '.json&callback=parseThread';
					document.head.appendChild(threadJsonp);
					//http://json2jsonp.com/?url=http://a.4cdn.org/d/thread/6561871.json&callback=parseThread
					var images = [];
					global.parseThread = function parseThread(resp){
						var goodExtensions = ['.jpg', '.jpeg', '.gif', '.bmp', '.png', '.webm'];
						images = resp.posts.filter(function(post){
							return goodExtensions.indexOf(post.ext) > -1;
						});
						images.forEach(function(post){
							//http(s)://i.4cdn.org/board/tim.ext
							post.imgURL = 'http://i.4cdn.org/' + board + '/' + post.tim + '' + post.ext;
							console.log(post.imgURL);
							//preloadImg(post.imgURL);
						});
						showImg();
						tickAuto();
					};

					var position = 0;

					function nextImg () {
						position += 1;
						if (position >= images.length) {
							position = 0;
						}
						preloadImg(images[position + 1 ].imgURL);
						showImg();
						tickAuto();
					}
					$('#nextButton').click(nextImg);

					function prevImg () {
						position -= 1;
						if (position < 0) {
							position = images.length + position;
						}
						preloadImg(images[position - 1 ].imgURL);
						showImg();
						tickAuto();
					}
					$('#prevButton').click(prevImg);

					$(document).keydown(function (e) {
						if (e.keyCode === 37) {
							prevImg();
						}

						if (e.keyCode === 39) {
							nextImg();
						}

						//space
						if (e.keyCode === 32) {
							$('#autoCb').click();
						}
					});

					$('#autoSec').val(localStorage.getItem("autoSecValue") || 5);
					$('#autoSec').change(function (e) {
						localStorage.setItem("autoSecValue", $('#autoSec').val());
					});

					//tickAuto();
					var autoTimeout;
					function tickAuto () {
						clearTimeout(autoTimeout);
						autoTimeout = setTimeout(function(){
							if ( $('#autoCb').prop( "checked" )) {
								nextImg();
							}
							tickAuto();
						}, $('#autoSec').val() * 1000);
					}
					$('#autoCb').click(function () {
						 clearTimeout(autoTimeout);
						 tickAuto();
					});

					function showImg() {
						//todo video array
						if (images[position].ext === '.webm') {
							$('#viewer').css("background-image", "url()");
							$('#videoViewer').show().attr('src', images[position].imgURL);

						} else {
							$('#videoViewer').hide();
							$('#viewer').css("background-image", "url(" + images[position].imgURL + ")");
						}
						$('#counter').html((position + 1) + '/' + images.length);
					}

					///Preload
					var preloadBuffer = [];
					var preloadRuning = false;
					var loaded = -1;
					function preloadImg (href) {
						preloadBuffer.push(href);
						if (!preloadRuning) {
							loadNextImg();
						}
						function loadNextImg() {
							loaded += 1;
							preloadRuning = true;
							if (preloadBuffer.length === 0) {
								preloadRuning = false;
								return;
							}
							var i = new Image();
							i.onload = loadNextImg;
							i.src = preloadBuffer.shift();
							console.log('load: ' + i.src);
						}
					}
				});
			}(window));
		</script>

		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-71096916-1', 'auto');
		  ga('send', 'pageview');

		</script>
	</body>
</html>
