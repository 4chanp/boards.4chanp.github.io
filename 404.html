<!DOCTYPE html>
<html>
	<head>
		<style type="text/css">
			html {
				background: #777;
				color: #ededed;
				position: relative;
			}

			#viewer {
				 background-size: contain;
				 background-position: 50% 50%;
				 background-repeat: no-repeat;
			}

			#prevButton,
			#nextButton {
				position: absolute;
				top: 50%;
				font-size: 36px;
				left: 10px;
			}

			#nextButton {
				right: 10px;
			}

			/*background-image: url(http://imgur.com/ikG9Iau.jpg); background-size: contain; background-position: 50% 50%; background-repeat: no-repeat; */
		</style>
	</head>
	<body>

		<div id="prevButton">&lt;</div>
		<div id="nextButton">&gt;</div>

		<div id="viewer">
			<img id="imgViewer" src="" />
		</div>

		<script type="text/javascript">
			(function(global){
				var NOOP = function(){};
				var path = document.location.pathname;
				var board = path.split('/')[1];
				var threadJsonp = document.createElement('script');
				threadJsonp.src = 'http://json2jsonp.com/?url=http://a.4cdn.org' + path + '.json&callback=parseThread';
				document.head.appendChild(threadJsonp);
				//http://json2jsonp.com/?url=http://a.4cdn.org/d/thread/6561871.json&callback=parseThread
				var images = [];
				global.parseThread = function parseThread(resp){
					var goodExtensions = ['.jpg', '.jpeg', '.gif', '.bmp', '.png', '.webm'];
					images = resp.posts.filter(function(post){
						return goodExtensions.indexOf(post.ext) > -1;
					});
					images.forEach(function(post){
						//http(s)://i.4cdn.org/board/tim.ext
						post.imgURL = 'http://i.4cdn.org/' + board + '/' + post.tim + '' + post.ext;
						console.log(post.imgURL);
						preloadImg(post.imgURL);
					});
					showImg();
				};

				var position = 0;

				function nextImg () {
					position += 1;
					showImg();
				}
				document.getElementById('nextButton').addEventListener('click', nextImg);

				function prevImg () {
					position -= 1;
					showImg();
				}
				document.getElementById('prevButton').addEventListener('click', prevImg);

				function showImg() {
					console.log('QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ' + images[position].imgURL);
					var viewer = document.getElementById('viewer');
					viewer.style.backgroundImage = "url('" + images[position].imgURL + "');";
					var imgViewer = document.getElementById('imgViewer');
					imgViewer.src = images[position].imgURL;
				}

				///Preload
				var preloadBuffer = [];
				var preloadRuning = false;
				function preloadImg (href) {
					preloadBuffer.push(href);
					if (!preloadRuning) {
						loadNextImg();
					}
					function loadNextImg() {
						preloadRuning = true;
						if (preloadBuffer.length === 0) {
							preloadRuning = false;
							return;
						}
						var i = new Image();
						i.onload = loadNextImg;
						i.src = preloadBuffer.shift();
						console.log('load: ' + i.src);
					}
				}

			}(this));
		</script>
	</body>
</html>
